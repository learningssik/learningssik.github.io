---
layout: post
title: "RAG 검색 정확도를 높이는 컬럼 태그 자동 생성 시스템"
date: 2025-11-27 14:00:00 +0900
categories: tech
tags: [RAG, Azure AI Search, OpenAI, 벡터 검색, 메타데이터, 자동화, Airflow]
excerpt: "벡터 검색 품질을 개선하기 위해 LLM을 활용한 컬럼 태그 자동 생성 시스템을 구축한 경험을 공유합니다."
---

## 문제 상황

우리 팀에서 운영하는 자연어 기반 데이터 분석 시스템에서는 사용자가 질문을 하면 관련 테이블과 컬럼을 찾아주는 RAG 검색 기능을 제공하고 있습니다. 그런데 검색 결과가 기대만큼 정확하지 않다는 피드백이 계속 들어왔습니다.

문제를 분석해보니 컬럼 설명 필드에 불필요한 문장형 표현과 예시 정보가 많아서 벡터 임베딩 과정에서 의미적 노이즈가 발생하고 있었습니다. 예를 들어 "사용자 가입일" 컬럼의 설명이 "이 컬럼은 사용자가 서비스에 가입한 날짜를 저장하는 필드입니다. 예를 들어 2024-01-15와 같은 형식으로 저장됩니다."처럼 되어 있으면, 정작 핵심인 "가입일"보다 "예를 들어", "형식" 같은 단어들이 벡터 공간에서 영향을 미치게 됩니다.

## 해결 방안: 검색 전용 태그 필드 생성

고민 끝에 벡터 검색에 최적화된 전용 필드를 새로 만들기로 했습니다. 기존 컬럼 설명은 사람이 읽기 위한 것이고, 새로운 `ATTR_TAG` 필드는 순수하게 벡터 검색을 위한 것으로 분리하는 전략입니다.

### 초기 시도와 실패

처음에는 단순하게 키워드만 나열하면 되지 않을까 생각했습니다.

```
user_signup_date, registration_date, join_timestamp
```

하지만 이 방식은 문제가 있었습니다:
- 단어 간 문맥이 없어 임베딩 품질이 떨어짐
- 동의어 매칭이 제대로 안 됨
- 유사도 계산 시 관련 항목을 놓치는 경우가 많음

### 개선된 접근: 명사 중심 문장

결국 명사 중심의 자연스러운 문장으로 생성하는 방식으로 변경했습니다. 불필요한 조사나 서술어는 제거하되, 의미적 문맥은 유지하는 것이 핵심입니다.

**Before**: "이 컬럼은 사용자의 서비스 가입 날짜를 나타낸다"  
**After**: "서비스 사용자 고유 구분 식별자 가입일 등록일"

## LLM 프롬프트 설계

가장 중요한 부분은 LLM에게 어떻게 지시할 것인가였습니다. 여러 번의 시행착오 끝에 다음과 같은 프롬프트를 완성했습니다:

```python
def make_col_tag(row): 
   response = client.chat.completions.create(
      model="gpt4o", 
      messages=[
         {"role": "system", "content": f"""
         너는 데이터 엔지니어링 전문가이자 데이터 메타데이터 설계자이다.
         주어진 컬럼 정보를 기반으로, 벡터 검색 시스템에서 의미적으로 
         가장 잘 검색될 수 있도록 태그를 생성해야 한다.

         제약 조건:
         1. semantic_summary 생성 규칙
            - 명사 중심의 단어 구조 문장으로 작성
            - "이 컬럼은", "~이다" 같은 서술어 금지
            - 간결하게 핵심 단어만 배열
            
         2. expanded_tags 강화 규칙
            - 동의어, 유의어, 대체 표현을 최대 3가지 추가
            - 예: '장치펫명' -> '단말 펫명', '기기 펫명', '디바이스 펫네임'
            - ARPU, DLV, CLV 같은 약어는 한국어 표현도 추가
            
         출력 형식:
         - 따옴표와 콤마 없이 띄어쓰기로 구분
         - 중복 단어 제거
         - 예시: 부가서비스 로밍 요금제 시작일
         """},
         {"role": "user", "content": f"""
         컬럼 논리명: {row['ATTR_LOGI_NM']}, 
         컬럼 설명: {row['ATTR_DESCR']}
         """}
      ]
   )
   return response.choices[0].message.content
```

핵심은 세 가지입니다:
1. **명사 중심**: 불필요한 조사 제거
2. **동의어 확장**: 검색 가능성 증가
3. **전문 용어 한글화**: ARPU → "가입자당 평균 수익"

## Airflow로 자동화

매일 밤 자동으로 실행되도록 Airflow DAG를 구성했습니다. 전체 프로세스는 다음과 같습니다:

```python
def run_etl():
    # 1. 인덱스 목록 조회
    indexes = index_client.list_index_names()
    col_index_list = []
    
    exclude_keywords = ['prod', 'open', 'edu', 'intg', 'test']
    for index_name in indexes:
        if 'col' in index_name and not any(keyword in index_name 
                                          for keyword in exclude_keywords):
            col_index_list.append(index_name)
    
    # 2. 각 인덱스 처리
    for col_index_name in col_index_list:
        col_search_client = SearchClient(
            endpoint=service_endpoint, 
            index_name=col_index_name, 
            credential=credential
        )
        
        col_df = load_from_azure(col_search_client)
        
        # 3. 각 컬럼에 대해 태그 생성
        for _, row in col_df.iterrows():
            row['ATTR_TAG'] = make_col_tag(row)
        
        # 4. 인덱스 업데이트
        update_index(col_search_client, col_df, ['id', 'ATTR_TAG'])
        
        # 5. dev -> prod 복사
        target_index_name = get_target_index_prod(col_index_name)
        copy_paste_index(col_index_name, target_index_name)
```

특히 dev 환경에서 먼저 생성하고 검증한 후 prod로 복사하는 방식으로 안전성을 확보했습니다.

## 실제 결과

**Before (기존 컬럼 설명)**
```
컬럼명: 결제_상태코드
설명: 주문의 결제 상태를 나타내는 코드값입니다. 
      결제완료, 결제취소 등의 값이 들어갑니다.
```

**After (생성된 태그)**
```
주문 결제 상태 코드 결제완료 결제취소 결제대기 승인 취소
```

훨씬 간결하면서도 검색에 필요한 모든 키워드가 포함되어 있습니다. 동의어도 자동으로 추가되어 "승인", "취소" 같은 관련 용어로도 검색이 잘 됩니다.

**통신 전문 용어 예시**
```
컬럼명: ARPU금액
Before: ARPU 금액
After: ARPU 가입자당 평균 수익 금액 매출
```

## 성능 개선 효과

태그 시스템 도입 후 측정한 결과입니다:

- **검색 정확도**: 약 30% 향상 (사용자 피드백 기반)
- **처리 시간**: 전체 컬럼 인덱스 약 1시간 40분 소요
- **유지보수**: 수동 태깅 작업 완전 자동화

특히 "ARPU", "DLV" 같은 통신 업계 전문 용어를 "가입자당 평균 수익", "단말 유지기간" 같은 한국어 표현과 함께 저장하니, 비전문가도 쉽게 검색할 수 있게 되었습니다.

## 배운 점

### 1. 벡터 검색은 문맥이 중요합니다

단순 키워드 나열보다 명사 중심 문장이 훨씬 효과적입니다. 임베딩 모델은 단어 간의 관계를 학습하기 때문에, 문맥이 있는 표현이 더 좋은 벡터를 만듭니다.

### 2. LLM 프롬프트는 구체적으로

"간결하게 작성해줘"보다 "명사만 사용하고 조사는 제거해줘"가 훨씬 명확합니다. 예시를 함께 제공하면 더 좋습니다.

### 3. 자동화가 핵심입니다

수천 개 컬럼을 수동으로 관리하는 건 불가능합니다. 처음 설정에 시간이 걸리더라도 자동화해두면 장기적으로 큰 이득입니다.

### 4. 점진적 개선

처음부터 완벽한 프롬프트를 만들 수 없습니다. 실제 결과를 보면서 계속 개선해나가는 것이 중요합니다.

## 다음 단계

현재는 컬럼 태그만 자동 생성하지만, 앞으로는:
- 테이블 설명 자동 생성
- 다국어 태그 지원 (한영 병기)
- 임베딩 품질 자동 검증 시스템
- A/B 테스트를 통한 프롬프트 최적화

를 추가할 계획입니다.

RAG 시스템을 운영하면서 메타데이터 품질이 얼마나 중요한지 다시 한번 깨달았습니다. 좋은 데이터가 좋은 검색을 만듭니다.
